
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mistry AI - The Mystical AI Assistant</title>
    <meta name="description" content="Mistry AI - Your mystical AI assistant powered by ancient wisdom and modern intelligence">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cinzel+Decorative:wght@400;700;900&family=Railway:wght@400;500;600&family=Poppins:wght@300;400;500;600&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'cinzel-deco': ['"Cinzel Decorative"', 'serif'],
                        'railway': ['Railway', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif'],
                        'quicksand': ['Quicksand', 'sans-serif'],
                    },
                    colors: {
                        mystical: {
                            teal: '#0d9488',
                            green: '#22c55e',
                            gold: '#fbbf24',
                            dark: '#0f172a',
                            light: '#f8fafc'
                        }
                    },
                    keyframes: {
                        'sparkle': {
                            '0%, 100%': { transform: 'scale(1) rotate(0deg)', opacity: '1' },
                            '50%': { transform: 'scale(1.2) rotate(180deg)', opacity: '0.8' }
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    },
                    animation: {
                        'sparkle': 'sparkle 2s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite'
                    }
                }
            }
        }
    </script>

    <style>
        .delay-2000 { animation-delay: 2s; }
        .delay-500 { animation-delay: 0.5s; }
        
        /* Custom scrollbar */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(251, 191, 36, 0.5);
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(251, 191, 36, 0.7);
        }

        /* Toast styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.9);
            color: #fbbf24;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #fbbf24;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-teal-600 via-teal-600 to-green-500 relative overflow-hidden">
    <!-- Sparkles -->
    <div class="absolute top-10 left-10 text-yellow-400 animate-sparkle">
        <i data-lucide="sparkles" class="w-6 h-6"></i>
    </div>
    <div class="absolute top-20 right-16 text-yellow-400 animate-sparkle">
        <i data-lucide="sparkles" class="w-5 h-5"></i>
    </div>
    <div class="absolute bottom-32 left-20 text-yellow-400 animate-sparkle delay-2000">
        <i data-lucide="sparkles" class="w-7 h-7"></i>
    </div>
    <div class="absolute bottom-20 right-10 text-yellow-400 animate-sparkle delay-500">
        <i data-lucide="sparkles" class="w-6 h-6"></i>
    </div>

    <!-- Info Button -->
    <button id="infoBtn" class="fixed top-6 right-8 z-50 bg-white bg-opacity-90 hover:bg-yellow-400 hover:bg-opacity-85 text-yellow-600 border border-yellow-400 transition-all shadow-xl rounded-full p-0 flex items-center justify-center w-11 h-11">
        <i data-lucide="info" class="w-6 h-6"></i>
    </button>

    <div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
        <!-- Header -->
        <header class="text-center mb-8 animate-float relative">
            <div class="flex justify-center items-center mb-4 flex-col">
                <div class="rounded-full bg-white p-1 mb-2 shadow-lg">
                    <img 
                        src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDgiIGN5PSI0OCIgcj0iNDgiIGZpbGw9IiMwZDk0ODgiLz4KPHN2ZyB4PSIyNCIgeT0iMjQiIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmYmJmMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPHN0YXIgY3g9IjEyIiBjeT0iMTIiIHI9IjMiLz4KPHN0YXIgY3g9IjE5IiBjeT0iNyIgcj0iMiIvPgo8c3RhciBjeD0iNSIgY3k9IjE3IiByPSIyIi8+Cjwvc3ZnPgo8L3N2Zz4K"
                        alt="Mistry AI Logo"
                        class="w-24 h-24 rounded-full drop-shadow-lg"
                    />
                </div>
                <div>
                    <h1 class="font-cinzel-deco text-5xl font-bold text-white drop-shadow-lg mb-2 tracking-wide">
                        Mistry AI
                    </h1>
                    <p class="font-cinzel-deco text-xl text-slate-100 mb-2">
                        Mistry AI
                    </p>
                    <p class="font-cinzel-deco text-xl text-slate-100">
                        The Mystical AI Assistant
                    </p>
                </div>
            </div>
            <p class="font-poppins text-slate-200 italic">
                "Wisdom from ancient scrolls, powered by modern enchantments"
            </p>
        </header>

        <!-- File Memory Panel -->
        <div id="fileMemoryPanel" class="bg-white bg-opacity-15 backdrop-blur-sm border border-yellow-400 border-opacity-40 mb-4 p-4 rounded-lg hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-slate-100 font-quicksand font-semibold flex items-center">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                    AI Memory (<span id="fileCount">0</span> files)
                </h3>
                <button id="clearAllFiles" class="bg-white bg-opacity-20 text-slate-100 hover:bg-white hover:bg-opacity-30 border border-yellow-400 border-opacity-30 px-3 py-1 rounded text-sm">
                    Clear All
                </button>
            </div>
            <div id="fileList" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Chat Box -->
        <div class="bg-white bg-opacity-10 backdrop-blur-sm border border-yellow-400 border-opacity-30 mb-6 h-128 overflow-hidden rounded-lg">
            <div class="h-full flex flex-col">
                <div id="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-6 chat-container">
                    <div id="welcomeMessage" class="text-center mt-16">
                        <div class="bg-white rounded-xl p-12 mx-auto max-w-lg shadow-2xl">
                            <i data-lucide="sparkles" class="mx-auto mb-6 text-teal-600 w-16 h-16"></i>
                            <h3 class="text-2xl font-quicksand font-semibold text-slate-800 mb-4">
                                Welcome to the mystical realm...
                            </h3>
                            <p class="text-slate-600 font-quicksand text-lg leading-relaxed">
                                Ask Mistry AI anything, and receive wisdom beyond time. Upload files to give me context and memory.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-wrap gap-3 mb-4 justify-center">
            <button id="modelBtn" class="bg-white text-slate-800 hover:bg-gray-100 font-railway border border-yellow-400 border-opacity-30 px-4 py-2 rounded">
                Scroll: 1
            </button>
            <button id="speakBtn" class="bg-white text-slate-800 hover:bg-gray-100 font-railway border border-yellow-400 border-opacity-30 px-4 py-2 rounded flex items-center">
                <i data-lucide="volume-2" class="w-4 h-4 mr-2"></i>
                Speak Wisdom
            </button>
            <button id="voiceBtn" class="bg-white text-slate-800 hover:bg-gray-100 font-railway border border-yellow-400 border-opacity-30 px-4 py-2 rounded flex items-center">
                <i data-lucide="mic" class="w-4 h-4 mr-2"></i>
                Voice Spell
            </button>
            <button id="clearBtn" class="bg-white text-slate-800 hover:bg-gray-100 font-railway border border-yellow-400 border-opacity-30 px-4 py-2 rounded flex items-center">
                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                Clear Scrolls
            </button>
        </div>

        <!-- Input Area -->
        <div class="flex gap-4 items-end">
            <input type="file" id="fileInput" class="hidden">
            <button id="uploadBtn" class="bg-yellow-400 bg-opacity-80 hover:bg-yellow-400 text-slate-800 font-railway px-6 py-3 rounded flex items-center">
                <i data-lucide="upload" class="w-5 h-5 mr-2"></i>
                Upload
            </button>
            <textarea 
                id="messageInput" 
                placeholder="Speak your query to Mistry AI..."
                class="flex-1 bg-white bg-opacity-25 border-2 border-yellow-400 border-opacity-40 text-slate-100 placeholder-slate-300 font-poppins text-base min-h-20 resize-none focus:border-yellow-400 focus:border-opacity-60 focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-30 p-3 rounded"
                rows="3"
            ></textarea>
            <button id="sendBtn" class="bg-yellow-400 text-slate-800 hover:bg-yellow-400 hover:bg-opacity-80 font-railway px-6 py-3 h-20 rounded flex items-center" disabled>
                <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                Cast
            </button>
        </div>

        <footer class="text-center mt-8 text-slate-300 font-quicksand">
            <p>&copy; 2025 Mistry AI - Where ancient wisdom meets modern intelligence</p>
        </footer>
    </div>

    <!-- Info Dialog -->
    <div id="infoDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">About Mistry AI</h3>
                <button id="closeDialog" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-4">
                Mistry AI is your mystical AI assistant. This standalone version works completely offline with built-in math solving and file analysis capabilities.
            </p>
            <p class="text-sm text-gray-500">
                Features: Math problem solving, file processing, voice recognition, and mystical wisdom!
            </p>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // App state
        let messages = [];
        let fileMemory = [];
        let currentModel = 1;
        let lastBotResponse = '';
        let isLoading = false;

        // DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const fileMemoryPanel = document.getElementById('fileMemoryPanel');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');

        // Math operations
        function isMathProblem(input) {
            const mathPatterns = [
                /\d+\s*[+\-*/Ã·Ã—]\s*\d+/,
                /what\s+is\s+\d+/i,
                /calculate/i,
                /solve/i,
                /\d+\s*\+\s*\d+/,
                /\d+\s*\-\s*\d+/,
                /\d+\s*\*\s*\d+/,
                /\d+\s*\/\s*\d+/,
                /\(\s*\d+/,
                /sqrt|square\s+root/i,
                /percentage|percent/i
            ];
            return mathPatterns.some(pattern => pattern.test(input));
        }

        function solveMathProblem(input) {
            try {
                // Extract mathematical expressions
                const mathExpressions = input.match(/[\d+\-*/().\s]+/g);
                if (!mathExpressions) return null;

                let result = '';
                for (let expr of mathExpressions) {
                    expr = expr.trim();
                    if (expr.length > 0 && /\d/.test(expr)) {
                        try {
                            // Safe evaluation of mathematical expressions
                            const cleanExpr = expr.replace(/[^0-9+\-*/().]/g, '');
                            if (cleanExpr) {
                                const evalResult = Function('"use strict"; return (' + cleanExpr + ')')();
                                result += `${cleanExpr} = ${evalResult}\n`;
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                }

                if (result) {
                    return `ðŸ§® **Mathematical Solution:**\n\n${result}\n*Calculated locally by Mistry AI's ancient arithmetic scrolls*`;
                }
            } catch (error) {
                return null;
            }
            return null;
        }

        // File processing
        function analyzeFileContent(fileName, content) {
            let analysis = `ðŸ“„ **File Analysis: ${fileName}**\n\n`;
            
            if (fileName.endsWith('.json')) {
                try {
                    const data = JSON.parse(content);
                    analysis += `**Type:** JSON Data\n`;
                    analysis += `**Structure:** ${Object.keys(data).length} main properties\n`;
                    analysis += `**Properties:** ${Object.keys(data).join(', ')}\n\n`;
                    analysis += `**Summary:** This JSON file contains structured data. I can help you analyze specific parts, search for information, or answer questions about the data structure and content.`;
                } catch (e) {
                    analysis += `**Type:** JSON File (parsing error)\n`;
                    analysis += `**Content Preview:** ${content.substring(0, 200)}...\n\n`;
                    analysis += `**Summary:** This appears to be a JSON file, but there might be formatting issues. I can still help analyze the content.`;
                }
            } else if (fileName.endsWith('.csv')) {
                const lines = content.split('\n').filter(line => line.trim());
                const headers = lines[0] ? lines[0].split(',') : [];
                analysis += `**Type:** CSV Data\n`;
                analysis += `**Rows:** ${lines.length - 1}\n`;
                analysis += `**Columns:** ${headers.length}\n`;
                analysis += `**Headers:** ${headers.join(', ')}\n\n`;
                analysis += `**Summary:** This CSV file contains tabular data. I can help you analyze trends, find specific information, or answer questions about the data.`;
            } else {
                const wordCount = content.split(/\s+/).length;
                analysis += `**Type:** Text Document\n`;
                analysis += `**Length:** ${content.length} characters, ${wordCount} words\n`;
                analysis += `**Preview:** ${content.substring(0, 300)}${content.length > 300 ? '...' : ''}\n\n`;
                analysis += `**Summary:** I've read and understood this document. Ask me anything about its content, request summaries, or have me help with analysis.`;
            }
            
            return analysis;
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Add message to chat
        function addMessage(text, sender, fileUrl = null, fileName = null) {
            if (welcomeMessage.style.display !== 'none') {
                welcomeMessage.style.display = 'none';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = `max-w-2xl px-6 py-4 rounded-xl font-quicksand text-base leading-relaxed ${
                sender === 'user' 
                    ? 'bg-yellow-400 text-slate-800 shadow-lg' 
                    : sender === 'system'
                        ? 'bg-slate-800 bg-opacity-80 text-yellow-400 border border-yellow-400 border-opacity-60 italic shadow-lg'
                        : 'bg-white bg-opacity-25 text-slate-100 border border-yellow-400 border-opacity-20 shadow-lg'
            }`;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'whitespace-pre-wrap break-words';
            
            if (fileUrl) {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = fileName;
                link.target = '_blank';
                link.className = 'underline hover:text-yellow-400 animate-pulse';
                link.textContent = text;
                textDiv.appendChild(link);
            } else {
                // Convert markdown-like formatting to HTML
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-black bg-opacity-20 px-1 rounded">$1</code>');
                textDiv.innerHTML = formattedText;
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'text-xs opacity-70 mt-2';
            timeDiv.textContent = new Date().toLocaleTimeString();
            
            messageContent.appendChild(textDiv);
            messageContent.appendChild(timeDiv);
            messageDiv.appendChild(messageContent);
            
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            if (sender === 'bot') {
                lastBotResponse = text;
            }
        }

        // Send message
        async function sendMessage() {
            const input = messageInput.value.trim();
            if (!input && fileMemory.length === 0) return;

            let fullPrompt = input;
            
            // Include files from memory
            if (fileMemory.length > 0) {
                const fileContext = fileMemory.map(file => 
                    `File: ${file.name}\nContent:\n${file.content}`
                ).join('\n\n---\n\n');
                
                fullPrompt = `Please analyze these files and answer my question: "${input}"\n\nFiles:\n${fileContext}`;
            }

            messageInput.value = '';
            addMessage(input || 'Analyzing uploaded files...', 'user');
            setLoading(true);

            try {
                // Check if it's a math problem first
                if (isMathProblem(fullPrompt)) {
                    const localSolution = solveMathProblem(fullPrompt);
                    if (localSolution) {
                        setTimeout(() => {
                            addMessage(localSolution, 'bot');
                            setLoading(false);
                            showToast('Calculated locally');
                        }, 500);
                        return;
                    }
                }

                // Try to connect to backend
                try {
                    const response = await fetch('http://localhost:5000/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: fullPrompt })
                    });

                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();
                    addMessage(data.reply, 'bot');
                    showToast('Response received');
                } catch (error) {
                    // Fallback responses when backend is not available
                    let response = generateOfflineResponse(fullPrompt);
                    addMessage(response, 'bot');
                    showToast('Generated offline response');
                }
            } catch (error) {
                addMessage('âš ï¸ Error: Could not process your request. Please try again.', 'bot');
                showToast('Failed to get response', 'error');
                console.error('Error:', error);
            } finally {
                setLoading(false);
            }
        }

        // Generate offline responses
        function generateOfflineResponse(input) {
            const lowerInput = input.toLowerCase();
            
            if (fileMemory.length > 0) {
                const fileNames = fileMemory.map(f => f.name).join(', ');
                return `ðŸ“š **File Analysis Complete**\n\nI've analyzed your uploaded files: ${fileNames}\n\n${analyzeFileContent(fileMemory[0].name, fileMemory[0].content)}\n\n*Note: This is an offline analysis. For more advanced AI processing, connect to the backend server.*`;
            }
            
            if (lowerInput.includes('hello') || lowerInput.includes('hi')) {
                return 'ðŸŒŸ Greetings, seeker of wisdom! I am Mistry AI, your mystical assistant. How may I illuminate your path today?';
            }
            
            if (lowerInput.includes('what') && lowerInput.includes('you')) {
                return 'âœ¨ I am Mistry AI, a mystical assistant that combines ancient wisdom with modern intelligence. I can help with math problems, analyze files, and provide guidance on various topics. Upload files to give me context about your specific needs!';
            }
            
            if (lowerInput.includes('help')) {
                return 'ðŸ”® **Mystical Guidance Available:**\n\nâ€¢ Upload files for analysis\nâ€¢ Ask math questions for instant calculation\nâ€¢ Use voice commands with the microphone\nâ€¢ Clear chat history with Clear Scrolls\nâ€¢ Listen to responses with Speak Wisdom\n\nWhat mystical knowledge do you seek?';
            }
            
            return 'ðŸŒ™ Your query has been received by the mystical realm. While I ponder the ancient texts, know that I work best when connected to my full power source. For now, I offer you this wisdom: sometimes the greatest answers come from within. What specific guidance do you seek?';
        }

        // Set loading state
        function setLoading(loading) {
            isLoading = loading;
            sendBtn.disabled = loading || (!messageInput.value.trim() && fileMemory.length === 0);
            
            if (loading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingMessage';
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white bg-opacity-25 text-slate-100 border border-yellow-400 border-opacity-20 px-6 py-4 rounded-xl font-quicksand shadow-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-yellow-400 rounded-full animate-bounce"></div>
                            <div class="w-3 h-3 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-3 h-3 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <span class="ml-3 text-base">Mistry AI is consulting the ancient texts...</span>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
            }
        }

        // File handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let fileContent = '';
                
                if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
                    fileContent = content;
                } else if (file.type === 'application/json') {
                    try {
                        fileContent = JSON.stringify(JSON.parse(content), null, 2);
                    } catch {
                        fileContent = content;
                    }
                } else {
                    fileContent = content;
                }
                
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: fileContent,
                    uploadedAt: new Date()
                };
                
                fileMemory.push(newFile);
                updateFileMemoryUI();
                
                const analysis = analyzeFileContent(file.name, fileContent);
                addMessage(analysis, 'system');
                showToast(`File "${file.name}" added to AI memory!`);
            };
            
            reader.readAsText(file);
        }

        // Update file memory UI
        function updateFileMemoryUI() {
            if (fileMemory.length === 0) {
                fileMemoryPanel.classList.add('hidden');
                return;
            }
            
            fileMemoryPanel.classList.remove('hidden');
            fileCount.textContent = fileMemory.length;
            
            fileList.innerHTML = '';
            fileMemory.forEach(file => {
                const fileTag = document.createElement('div');
                fileTag.className = 'bg-yellow-400 bg-opacity-20 text-slate-100 px-3 py-1 rounded-full text-sm flex items-center border border-yellow-400 border-opacity-30';
                fileTag.innerHTML = `
                    <span class="mr-2">${file.name}</span>
                    <button onclick="removeFile('${file.id}')" class="hover:bg-yellow-400 hover:bg-opacity-30 rounded-full p-1 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                fileList.appendChild(fileTag);
            });
            
            // Reinitialize icons for new elements
            lucide.createIcons();
            
            // Update placeholder
            messageInput.placeholder = fileMemory.length > 0 
                ? `Files in memory: ${fileMemory.map(f => f.name).join(', ')} - Ask your question...`
                : "Speak your query to Mistry AI...";
        }

        // Remove file from memory
        function removeFile(fileId) {
            fileMemory = fileMemory.filter(file => file.id !== fileId);
            updateFileMemoryUI();
            showToast('File removed from memory');
        }

        // Clear all files
        function clearAllFiles() {
            fileMemory = [];
            updateFileMemoryUI();
            showToast('All files cleared from memory');
        }

        // Voice recognition
        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showToast('Speech recognition not supported in this browser', 'error');
                return;
            }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.onresult = function(event) {
                messageInput.value = event.results[0][0].transcript;
                sendBtn.disabled = false;
            };
            recognition.onerror = function(event) {
                showToast(`Voice recognition error: ${event.error}`, 'error');
            };
            recognition.start();
        }

        // Text to speech
        function speakResponse() {
            if (!lastBotResponse) {
                showToast('No response to speak', 'error');
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(lastBotResponse.replace(/[*_`#]/g, ''));
            utterance.lang = 'en-US';
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // Clear chat
        function clearChat() {
            messages = [];
            chatContainer.innerHTML = '';
            welcomeMessage.style.display = 'block';
            chatContainer.appendChild(welcomeMessage);
            showToast('Chat cleared');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize icons
            lucide.createIcons();
            
            // Message input
            messageInput.addEventListener('input', function() {
                sendBtn.disabled = isLoading || (!this.value.trim() && fileMemory.length === 0);
            });
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        sendMessage();
                    }
                }
            });
            
            // Buttons
            sendBtn.addEventListener('click', sendMessage);
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            document.getElementById('modelBtn').addEventListener('click', function() {
                currentModel = currentModel === 1 ? 2 : 1;
                this.textContent = `Scroll: ${currentModel}`;
            });
            
            document.getElementById('speakBtn').addEventListener('click', speakResponse);
            document.getElementById('voiceBtn').addEventListener('click', startVoiceRecognition);
            document.getElementById('clearBtn').addEventListener('click', clearChat);
            document.getElementById('clearAllFiles').addEventListener('click', clearAllFiles);
            
            // Info dialog
            document.getElementById('infoBtn').addEventListener('click', function() {
                document.getElementById('infoDialog').classList.remove('hidden');
            });
            
            document.getElementById('closeDialog').addEventListener('click', function() {
                document.getElementById('infoDialog').classList.add('hidden');
            });
            
            // Close dialog when clicking outside
            document.getElementById('infoDialog').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });

        // Make functions available globally
        window.removeFile = removeFile;
        window.clearAllFiles = clearAllFiles;
    </script>

    <style>
        .h-128 { height: 32rem; }
    </style>
</body>
</html>
